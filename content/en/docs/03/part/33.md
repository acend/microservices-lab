---
title: "3.3 Building a Microservice"
linkTitle: "3.3  Building a Microservice"
weight: 330
sectionnumber: 3.3
description: >
  Understand the setup and build your own order microservice.
---

In this stage we will have a look at the setup of a microservice and we will implement the `order` microservice.

{{% alert title="Stock Microservice" color="warning" %}} The `order` and `stock` microservice have a similar setup. Therefore, we will mostly only work on the `order` microservice. If you have to make changes to the `stock` microservice it is clearly stated. {{% /alert %}}

## Order Microservice
In this section we will walk through the complete building of a microservice. We have already made the configuration for our containers in the docker-compose file. Now we will write our `order` microservice.

{{% alert title="Existing classes" color="info" %}} Some classes are already created. These are used either for testing, simulation or the integration of the `lra-coordinator` which we will use later. For now, you can just ignore them. {{% /alert %}}

{{% alert title="Existing dependencies" color="primary" %}} As we have seen the relevant parts for tracing and metric from the previous lab, these dependencies are already included. {{% /alert %}}

## Datasource 
First we are going to setup the database connection and tables.

### Task {{% param sectionnumber %}}.1 - Setup database dependencies

Ensure the following dependencies are specified in the `pom.xml`. 

GroupId      |   ArtifactId                      | Description            | Detailed information
-------------|-----------------------------------|------------------------|--------------------------
`io.quarkus`             | `quarkus-hibernate-orm-panache` | Hibernate ORM with Panache support | [Simplified Hibernate ORM with Panache](https://quarkus.io/guides/hibernate-orm-panache)
`io.quarkus`             | `quarkus-jdbc-postgresql`     | JDBC PostgreSQL support for Quarkus | [Datasources](https://quarkus.io/guides/datasource)
`io.quarkus`             | `quarkus-liquibase`  |  Liquibase Quarkus integration for database schema change management | [Using Liquibase](https://quarkus.io/guides/liquibase)
`io.opentracing.contrib` | `opentracing-jdbc`  |  Provides traces for database queries. | [Using OpenTracing](https://quarkus.io/guides/opentracing)


{{% details title="Dependencies Task Hint" %}}
The following dependencies have to be added.
```xml
<dependencies>
    ...
    <!-- database dependencies -->
    <dependency>
      <groupId>io.quarkus</groupId>
      <artifactId>quarkus-hibernate-orm-panache</artifactId>
    </dependency>
    <dependency>
      <groupId>io.quarkus</groupId>
      <artifactId>quarkus-liquibase</artifactId>
    </dependency>
    <dependency>
      <groupId>io.quarkus</groupId>
      <artifactId>quarkus-jdbc-postgresql</artifactId>
    </dependency>

    <!-- Tracing, Metrics and Health dependencies -->
    <dependency>
      <groupId>io.opentracing.contrib</groupId>
      <artifactId>opentracing-jdbc</artifactId>
    </dependency>
    ...
</dependencies>
```
{{% /details %}}


After adding these dependencies, we are ready to configure quarkus to use the database.
To do so, make the following changes in the `src/main/resources/application.properties`.
```text
# datasource
quarkus.datasource.db-kind = postgresql
quarkus.datasource.username = admin
quarkus.datasource.password = 1234
quarkus.datasource.jdbc.url = jdbc:tracing:postgresql://localhost:5432/admin
quarkus.datasource.jdbc.driver=io.opentracing.contrib.jdbc.TracingDriver
quarkus.hibernate-orm.dialect=org.hibernate.dialect.PostgreSQLDialect

# drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation = none

# liquibase properties
quarkus.liquibase.migrate-at-start=true
quarkus.liquibase.clean-at-start=true
```

This will defined our datasource and specify that liquibase should clean and migrate the database schema at startup.


### Task {{% param sectionnumber %}}.2 - Setup database schema
Since our dependencies and configuration is complete, we can start to build the schema. We will use the database migration tool liquibase.

* Create folder `src/main/resources/db`
* Create file `src/main/resources/db/changeLog.xml`

You have to use the liquibase xml syntax to create the tables and sequence. 

{{% alert title="Naming" color="warning" %}} Please be precise with the naming of tables and fields, or you might run into trouble in later steps. {{% /alert %}}

Create the `shoporder` table in the `changeLog.xml`. This table will store our orders.
```text
admin=# \d shoporder;
                     Table "shoporder"
 Column |          Type          | Collation | Nullable | Default
--------+------------------------+-----------+----------+---------
 id     | bigint                 |           | not null |
 status | character varying(255) |           |          |

Indexes:
    "shoporder_pkey" PRIMARY KEY, btree (id)
```

Create the `articleorder` table in the `changeLog.xml`. This table reflects the effective articles which have been ordered.
```text
admin=# \d articleorder;
             Table "articleorder"
  Column   |  Type   | Collation | Nullable | Default
-----------+---------+-----------+----------+---------
 id        | bigint  |           | not null |
 articleid | bigint  |           |          |
 amount    | numeric |           |          |

Indexes:
    "articleorder_pkey" PRIMARY KEY, btree (id)
```

Create the mapping table in the `changeLog.xml`. This table is used to build the mapping from `shoporder` to the `articleorder`.
```text
admin=# \d shoporder_articleorder;
           Table "shoporder_articleorder"
      Column      |  Type  | Collation | Nullable | Default
------------------+--------+-----------+----------+---------
 shoporder_id     | bigint |           | not null |
 articleorders_id | bigint |           | not null |
```

Finally, create the hibernate sequence in the `changeLog.xml`.
```text
admin=# \d hibernate_sequence;
                     Sequence "hibernate_sequence"
  Type  | Start  | Minimum |       Maximum       | Increment | Cycles? | Cache
--------+--------+---------+---------------------+-----------+---------+-------
 bigint | 100000 |       1 | 9223372036854775807 |         1 | no      |     1
```

{{% details title="Task Hint" %}}
Your `changeLog.xml` should look like this:

```xml
<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd
    http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet author="main" id="1">
        <createTable tableName="shoporder">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="status" type="varchar(255)"/>
        </createTable>

        <createTable tableName="articleorder">
            <column name="id" type="bigint">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="articleid" type="bigint"/>
            <column name="amount" type="number"/>
        </createTable>

        <createTable tableName="shoporder_articleorder">
            <column name="shoporder_id" type="bigint">
                <constraints nullable="false" foreignKeyName="shoporder_article_shoporder_fk" referencedColumnNames="id"/>
            </column>
            <column name="articleorders_id" type="bigint">
                <constraints nullable="false" foreignKeyName="shoporder_article_articleorder_fk" referencedColumnNames="id"/>
            </column>
        </createTable>

        <createSequence sequenceName="hibernate_sequence" startValue="100000"/>
    </changeSet>
</databaseChangeLog>
```
{{% /details %}}

## Entities

{{% details title="Task Hint" %}}
{{% /details %}}

{{% details title="Task Hint" %}}
{{% /details %}}

## Rest Resource

## Rest Client





{{% details title="Task Hint" %}}
{{% /details %}}





